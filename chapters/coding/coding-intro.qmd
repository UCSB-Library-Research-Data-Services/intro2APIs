---
title: "Interacting with APIs Programmatically"
execute:
    echo: true
format:
    html:
        code-fold: true
lightbox: true
---

Although tools like Postman and Bruno are great for testing and exploring APIs, it's plausible that your goal is to retrieve data from multiple endpoints, select specific fields, automate processes, or manipulate the data obtained in a response.

Most of the high-level programming languages used in data science and digital humanities (e.g., Python, R, JavaScript) have libraries that allow you to interact with APIs programmatically. That means that the heavy lifting of constructing and handling requests, parsing responses, and managing authentication is taken care of by the library. The dificulty usually lies in how complex the API is, particularly the multiple methods of authentication, the structure of the endpoints, and the format of the responses.

In this section, we will use Python to interact with the [Digital Public Library of America (DPLA) API](https://pro.dp.la/developers/api-codex). The rationality behind this choice is that the DPLA API, besides the fact that it provides access to a large amount of data, has a relatively straightforward structure and authentication process, making it an ideal candidate for learning how to interact with APIs programmatically. 

::: {.callout-note appearance="simple" collapse="false"}
## Comming Soon!

We are planning to expand this section to include examples of how to interact with APIs using R and JavaScript as well. Stay tuned for updates!
:::

## Where to Start?

Before writing a single line of code, we need to understand the API requests and the structure of the responses. Therefore, the first place we must go is the API documentation. In the case of the DPLA API, we can find in the [API Codex](https://pro.dp.la/developers/api-codex){target="_blank"}. The DPLA developers are very generous and provide a 'how to use it' guide that summarizes the basic steps to interact with the API in three steps:

1. **Request an API key from DPLA**: The way to generate an API key is to send a request to a DPLA endpoint with your email address. A 32-character hash API key will be sent to your email. 

To request an API key, open your terminal and use the `curl` command:

```bash
curl "https://api.dp.la/v2/api_key/YOUR_EMAIL@example.com"
```

Replace `YOUR_EMAIL@example.com` with your actual email address. The DPLA will send you a 32-character API key to your email inbox.

:::{.callout-warning appearance="simple" collapse="false"}
Keep your API key secure and do not share it publicly. This is very important, as you API key is like a password associated with your email address. The developers of the DPLA have a very lenient policy regarding the use of the API, but if they detect any suspicious activity associated with your API key, they may revoke it without notice. See the [API policies](https://pro.dp.la/developers/policies){target="_blank"} for more information.
:::

2. **Do a request to the API**: With your API key, you're ready to make your first request to the API. Here you can test that the API key works and that you can successfully retrieve data from the API. 

```{ojs}
viewof method = Inputs.select(["GET"], {
  label: "HTTP Method",
  attributes: {
  class: "form-select mb-3"
  }
})

viewof endpoint = Inputs.text({
  label: "Endpoint path", 
  placeholder: "/v2/items",
  value: "/v2/items",
  attributes: {
  class: "form-control mb-3"
  }
})

viewof query = Inputs.text({
    label: "Search: ",
    placeholder: "weasel, cat, dog, etc.",
    value: "cat",
    attributes: {
    class: "form-control mb-3"
    }
})

viewof apikey = Inputs.password({
  label: "API Key",
  placeholder: "Your DPLA API key",
  value: "",
  attributes: {
  class: "form-control mb-3"
  }
})

// Function to make the API request
async function fetchFromApi(method, path, q, api_key) {
  const baseUrl = "https://api.dp.la";
  const targetUrl = `${baseUrl}${path}?q=${q}&page_size=1&api_key=${api_key}`;
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

  try {
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error("Proxy server is down.");

    const wrapper = await response.json();
    
    // We wrap the URL in the AllOrigins proxy
    // See https://allorigins.win/ for more details on how it works and its limitations.
    const dplaStatus = wrapper.status.http_code; 
    const data = JSON.parse(wrapper.contents);

    // Check for authentication errors first (403 or "Unauthorized" message)
    if (dplaStatus === 403 || data.message === "Unauthorized") {
      return {
        data: { "Message": "üîë Invalid API Key. Please check your key and try again." },
        status: { code: 403, ok: false, text: "Unauthorized" }
      };
    }

    // Check for other DPLA errors (like 404 or 400)
    if (dplaStatus >= 400) {
      return {
        data: data,
        status: { code: dplaStatus, ok: false, text: "DPLA Error" }
      };
    }

    return { data, status: { code: 200, ok: true, text: "OK" } };

  } catch (error) {
    // Network or Parsing errors
    return {
      data: { "Message": `üåê Connection Error: ${error.message}` },
      status: { code: 500, ok: false, text: "Network Error" }
    };
  }
}

response = {
  const result = await fetchFromApi(method, endpoint, query, apikey);
  return result;
}

viewof prettyResponse = {
  let content;

  if (response.data.Message) {
    content = html`<div class="alert alert-warning m-0">${response.data.Message}</div>`;
  } else {
    content = html`<pre class="card-body m-0" style="background-color: #f8f9fa; max-height: 400px; overflow-y: auto;">${JSON.stringify(response.data, null, 2)}</pre>`;
  }

  const badgeClass = response.status.ok ? "bg-success" : "bg-danger";

  const container = html`<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
  <span>Response</span>
  <span class="badge ${badgeClass}">${response.status.code} ${response.status.text}</span>
  </div>
  ${content}
  </div>`;
  return container;
}


```

:::{.callout-note appearance="simple" collapse="false"}
## API Key Privacy
The API key is not stored anywhere in this book, and it's used exclusively to make the request to the DPLA API. Once you close the browser tab or refresh the page, the API key will be lost.
:::