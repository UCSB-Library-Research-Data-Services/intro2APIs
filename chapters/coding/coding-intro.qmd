---
title: "Getting Started with APIs and Coding"
execute:
    echo: true
format:
    html:
        code-fold: true
lightbox: true
---

Tools like Postman and Bruno are great for exploring and testing APIs. But if you want to pull data from multiple endpoints, repeat requests, automate workflows, or clean and analyze results, you‚Äôll quickly want to use code.

Most high-level languages used in data science and digital humanities (Python, R, JavaScript, etc.) have libraries for working with web APIs. Those libraries handle the basics‚Äîsending requests, parsing responses, and (often) authentication‚Äîso you can focus on what data you need and how to use it. The hardest part is usually the API itself: its authentication requirements, endpoint structure, and response format.

In this section, we‚Äôll use Python with the [Digital Public Library of America (DPLA) API](https://pro.dp.la/developers/api-codex). DPLA is a good learning API because it offers a lot of public data and has a relatively straightforward structure and authentication process.

::: {.callout-note appearance="simple" collapse="false"}
## Coming soon

We plan to add R and JavaScript examples as well. For now, this chapter uses Python.
:::

## Where to Start?

Before writing code, it helps to understand what the API expects (requests) and what it returns (responses). The best place to start is the documentation‚Äîin this case, the DPLA [API Codex](https://pro.dp.la/developers/api-codex){target="_blank"}. The DPLA team provides a short ‚Äúhow to use it‚Äù guide that boils things down to two steps:

1. **Request an API key from DPLA**: To get a key, send a request with your email address. DPLA will email you a 32-character API key.

To request an API key, open your terminal and use the `curl` command:

```bash
curl "https://api.dp.la/v2/api_key/YOUR_EMAIL@example.com"
```

Replace `YOUR_EMAIL@example.com` with your actual email address. The DPLA will send you a 32-character API key to your email inbox.

:::{.callout-warning appearance="simple" collapse="false"}
Keep your API key secure and do not share it publicly. Your API key is like a password tied to your email address, and it can be revoked if it‚Äôs abused. See the DPLA [API policies](https://pro.dp.la/developers/policies){target="_blank"} for details.
:::

2. **Make a request to the API**: With your API key, you‚Äôre ready to test a request and confirm that you can retrieve data.

```{ojs}
viewof method = Inputs.select(["GET"], {
  label: "HTTP Method",
  attributes: {
  class: "form-select mb-3"
  }
})

viewof endpoint = Inputs.text({
  label: "Endpoint path", 
  placeholder: "/v2/items",
  value: "/v2/items",
  attributes: {
  class: "form-control mb-3"
  }
})

viewof query = Inputs.text({
    label: "Search: ",
    placeholder: "weasel, cat, dog, etc.",
    value: "cat",
    attributes: {
    class: "form-control mb-3"
    }
})

viewof apikey = Inputs.password({
  label: "API Key",
  placeholder: "Your DPLA API key",
  value: "",
  attributes: {
  class: "form-control mb-3"
  }
})

// Function to make the API request
async function fetchFromApi(method, path, q, api_key) {
  const baseUrl = "https://api.dp.la";
  const targetUrl = `${baseUrl}${path}?q=${q}&page_size=1&api_key=${api_key}`;
  // Using All Origins proxy to bypass CORS issues
  // See the documentation in https://allorigins.win/
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

  try {
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error("Proxy server is down.");

    const wrapper = await response.json();
    const dplaStatus = wrapper.status.http_code; 
    const data = JSON.parse(wrapper.contents);

    // Check for authentication errors first (403 or "Unauthorized" message)
    if (dplaStatus === 403 || data.message === "Unauthorized") {
      return {
        data: { "Message": "üîë Invalid API Key. Please check your key and try again." },
        status: { code: 403, ok: false, text: "Unauthorized" }
      };
    }

    // Check for other DPLA errors (like 404 or 400)
    if (dplaStatus >= 400) {
      return {
        data: data,
        status: { code: dplaStatus, ok: false, text: "DPLA Error" }
      };
    }

    return { data, status: { code: 200, ok: true, text: "OK" } };

  } catch (error) {
    // Network or Parsing errors
    return {
      data: { "Message": `üåê Connection Error: ${error.message}` },
      status: { code: 500, ok: false, text: "Network Error" }
    };
  }
}

response = {
  const result = await fetchFromApi(method, endpoint, query, apikey);
  return result;
}

viewof prettyResponse = {
  let content;

  if (response.data.Message) {
    content = html`<div class="alert alert-warning m-0">${response.data.Message}</div>`;
  } else {
    content = html`<pre class="card-body m-0" style="background-color: #f8f9fa; max-height: 400px; overflow-y: auto;">${JSON.stringify(response.data, null, 2)}</pre>`;
  }

  const badgeClass = response.status.ok ? "bg-success" : "bg-danger";

  const container = html`<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
  <span>Response</span>
  <span class="badge ${badgeClass}">${response.status.code} ${response.status.text}</span>
  </div>
  ${content}
  </div>`;
  return container;
}


```

:::{.callout-note appearance="simple" collapse="false"}
## API Key Privacy
The API key is not stored anywhere in this book, and it's used exclusively to make the request to the DPLA API. Once you close the browser tab or refresh the page, the API key will be lost.
:::

## Understanding the Response

For the sake of simplicity, we limit the response to one item. Even then, the response is large and not very human-readable at first. Here are a few fields that are especially useful when you‚Äôre getting started:

- [`count`](https://pro.dp.la/developers/field-reference#count){target="_blank"}, which indicates the total number of items that match the query.

```{ojs}

viewof countInfo = {
    let count;

    if (response.data.count !== undefined ){
    count = html`<div class="alert alert-info">Total items matching the query: <strong>${response.data.count}</strong></div>`
    } else {
    count = html`<div class="alert alert-secondary">Waiting for the response</div>`
    }

    return count;
}

```

- [`docs`](https://pro.dp.la/developers/field-reference#docs){target="_blank"}, which contains the actual data of the items retrieved. It's possible to access specific fields at this level, for example, the [`ingestDate`](https://pro.dp.la/developers/field-reference#ingestDate){target="_blank"} field, which indicates the date when the item was ingested into the DPLA.

```{ojs}
viewof ingestDateInfo = {
    let ingestDate;

    if (response.data.docs && response.data.docs[0] && response.data.docs[0].ingestDate) {
    ingestDate = html`<div class="alert alert-info">Ingest Date of the first item: <strong>${response.data.docs[0].ingestDate}</strong></div>`
    } else {
    ingestDate = html`<div class="alert alert-secondary">Waiting for the response</div>`
    }

    return ingestDate;
} 
```

- [`sourceResource`](https://pro.dp.la/developers/field-reference#sourceResource){target="_blank"}, which contains the metadata of the item, including fields like `title`, `creator`, `date`, `description`, etc.

```{ojs}
viewof source = {
    let title, creator, date;
    if (response.data.docs && response.data.docs[0] && response.data.docs[0].sourceResource) {
    const source = response.data.docs[0].sourceResource;
    title = source.title ? source.title[0] : "N/A";
    creator = source.creator ? source.creator[0] : "N/A";
    date = source.date ? source.date[0].displayDate : "N/A";
    return html`<div class="card">
    <div class="card-body">
    <h5 class="card-title">${title}</h5>
    <h6 class="card-subtitle mb-2 text-muted">Creator: ${creator}</h6>
    <p class="card-text">Date: ${date}</p>
    </div>
    </div>`;
    } else {
    return html`<div class="alert alert-secondary">Waiting for the response</div>`
    }
}
```

- [`provider`](https://pro.dp.la/developers/field-reference#provider){target="_blank"}, which indicates the institution that provided the item to the DPLA.

```{ojs}
viewof providerInfo = {
    let provider;
    if (response.data.docs && response.data.docs[0] && response.data.docs[0].provider) {
    provider = response.data.docs[0].provider.name || "N/A";
    return html`<div class="alert alert-info">Provider: <strong>${provider}</strong></div>`;
    } else {
    return html`<div class="alert alert-secondary">Waiting for the response</div>`
    }
}
```

These are just a few examples. To go further, see the DPLA documentation on [requests](https://pro.dp.la/developers/requests){target="_blank"} and [responses](https://pro.dp.la/developers/responses){target="_blank"}.

:::{.callout-warning appearance="simple" collapse="false"}
## Bulk downloads

The API is great for searching and sampling, but it‚Äôs not meant for downloading large volumes of data. If you need a full dataset, use DPLA‚Äôs [bulk download files](https://pro.dp.la/developers/bulk-download){target="_blank"} instead.
:::